# 狼人杀 后台设计

## 采用状态同步

* 状态同步即客户端将当前操作和状态发送到服务器，由服务器进行逻辑运算，再将服务器端计算得到的状态推送给客户端，由客户端进行更新。
* 服务器：存储全局状态和玩家状态，根据操作计算需要更新的状态，将需更新属性发送给玩家
* 客户端：存储自身状态，根据操作发送给服务器，并接受需要更新的属性并更新。
* 状态检查：客户端将自身状态发送给服务器，服务器检查是否一致，若不一致则将服务器端状态同步到玩家。每轮白天结束后进行（可与黑夜同步进行？）
* 防作弊：防止玩家在客户端即可读到全局信息。把数据传输都设置为单向，服务器传输给玩家的信息最少化

## 游戏逻辑

* 定12人标准版
  1. 狼人4人 村民4人 神民4人：猎人 女巫 预言家 白痴
  2. 顺序规则
     1. 第一天天黑
        1. 全员显示黑夜
        2. 狼人屏幕亮起，可被刀玩家列表出现，四人投票（可选加入少数服从多数选项），限定时间15秒，投票完毕也可结束回合。
        3. 女巫屏幕亮起，显示死亡玩家，屏幕下方出现选项：是否使用解药，选择结束后出现选择是否使用毒药，否则直接结束回合。
        4. 预言家屏幕亮起，显示可查验玩家列表，选中后出现该玩家身份（仅能验出神民或狼人两种结果）
        5. 猎人屏幕亮起，显示是否可以使用技能
        6. 白痴屏幕亮起，显示你是白痴，五秒后结束回合。
        7. 所有睁眼闭眼规则仍沿用面杀，房主设备开启音频，睁眼会播报。
     2. 第一天天亮
        1. （仅第一天黑夜过后进行）警长竞选，所有玩家屏幕上出现竞选选项以及候选人选项（即时更新），上警后可随时取消（此时不算退水），一定时间后（或全员点击确认后）上警结束
        2. 所有人屏幕显示第一夜死亡角色（此阶段猎人可亮身份并开枪，此时带走的）
        3. 第一晚死人有遗言，上帝宣布死讯后即可发言
        4. 上警发言阶段 上警玩家按顺序发言 发言完毕后点击完毕到下一个玩家发言阶段（~~此阶段~~狼人可自爆,狼人可随时自爆，之后发言终止，直接进入遗言阶段）（发言完毕后可选择退水）
        5. 所有玩家发言完毕后进入投票阶段（上警及退水玩家无投票权），非上警玩家可选择一名上警玩家投票，全员投票，定时，倒数结束后（也可进行结束投票）全员显示投票结果，警长屏幕出现警徽。
        6. 警长选择放逐投票发言顺序：警左警右或死左死右（一人死亡则死左死右或警左警右，两人或无人则警左警右）
        7. 全员发言完毕后进行放逐投票（警长票为1.5票），定时投票，投票完毕后再宣布结果。
        8. 若有平票，则进入pk环节，随机一人先发言，二人发言完毕后全员（活人）投票，投票同上。
        9. 若还有，重复pk，直到系统决出一人被放逐。（若是猎人则亮身份并开枪）
        10. 进入黑夜 全员屏幕显示黑夜
     3. 第二天及以后黑夜
        1. 规则和顺序同第一天黑夜
     4. 第二天及以后白天
        1. 上帝宣布死亡玩家，由于夜晚死亡所以无遗言。猎人除了被毒杀都可以开枪带走，带走的人算作与猎人同一时间死亡。
        2. 警长选择发言顺序（规则见3.6）
        3. 轮流发言，完毕后警长归票（包含在警长发言内，可以不参与客户端响应）
        4. 生者投票表决放逐
        5. 放逐者发表遗言
  3. 全局规则（可能在任何时候生效或可能在流程中调用多次的规则）
     1. 猎人死时可以带走一个，被毒死不行，带走的那个算作与猎人同一时间死亡
     2. 狼人可以在任何时候自爆，自爆后自己有遗言，然后全员进入黑夜
     3. 白天死的人有遗言，晚上没有，第一晚例外
     4. 自爆（后面再加）
     5. 投票：满30s或全员都投了即进入下一环节
  4. 获胜条件：
     1. 所有狼人出局-狼人败
     2. 屠城：狼人数量大于神民数量即可
     3. 屠边：四位神死亡或四位民死亡即可

## 运行逻辑（页面切换显示）

1.

## 细节化为代码逻辑（数据结构前后端行为通信）

1. 游戏逻辑部分
   1. 服务器端
      1. 流程
         1. 投票
            1. 根据存活玩家和流程得出可参与投票玩家，向可参与玩家客户端发送进入投票页面的命令，根据当前流程与存活玩家发送可投票对象、通过获取当前流程得知投票目的发送投票标题
            2. 客户端发送事件（识别id、投票对象）
            3. 通过id识别身份判断加10还是加15
            4. 通过投票对象识别被投票人（在存活玩家列表中遍历）并创建一个新数组（生命周期为单个函数），复制自存活玩家列表，为每个对象添加属性分数，并在每个事件监听到之后触发增加对应点数
            5. 比较并得出投票结果玩家
            6. 通过投票目的得到该玩家的状态改变，并调用修改状态修改该玩家的状态（也许就是一个赋值）
            7. 接受计时请求，请求数量符合可参与玩家后开始计时，同时发送启动客户端计时器命令，计时结束或接收投票请求数目符合可参与玩家后，发送投票结束页面命令
            8. 向所有客户端广播投票结果（结果对象以及投票列表）并广播全局状态，客户端根据状态更新页面。
         2. 修改状态
            1.
   2. 客户端
      1. 流程
         1. 投票
            1. 接受来自服务器的命令，进入投票页面，接收可投票对象动态渲染到页面，每个渲染元素添加事件监听，接受投票标题渲染到页面，渲染完毕后向服务器发送计时请求。
            2. 玩家点击可投票对象将请求发送到服务器，进入等待页面，期间接受计时器命令，接收到则启动计时器，本地计时器若到时间则显示“等待服务器返回结果”，未到时间之前服务器端结束命令搁置直到计时结束
            3. 接受来自服务器端结束命令并根据推送的投票结果实时渲染页面。
2. 数据结构部分
   1. 全局状态：
      1. 需要表示的量：
         1. 第几天、白天还是晚上
         2. 该时间要进行的流程（根据当前玩家状态动态生成。以数组表示，不同流程封装为独立对象，按数组内容调用）
         3. 全体活人（数组）
   2. 玩家状态（通用对象&全局生命周期&广播给全体客户端）
      1. 客户端id，身份id
      2. 生死状态（死因）
      3. 技能使用状态（总次数/使用次数）
      4. 是否为警长
   3. 各身份信息
      1. 特殊技能
      2. 获胜条件
      3. 名称
   4. 房间设定
      1. 房间名（缺省则为房主昵称）
      2. （隐藏）房间id（默认为房主id）
      3. 游戏人数
      4. 角色配置
      5. 获胜条件
      6. *自动计时时间（投票、回合等）
      7. *密码加入
   5. 游戏流程（可调用对象）
      1. 天黑
      2. 天亮
      3. 狼人行动
      4. 预言家行动
      5. 女巫行动
      6. 猎人行动（猎人技能）
      7. 白痴行动（白痴技能）
      8. 投票（不可更改）
         1. 标题（投票原因）
         2. 投票人（计算票权）
         3. 可投票对象（可选是否可见对象票数）
         4. 计时||计数
         5. 显示投票结果&统计表格
         6. 若有平票则增加发言环节并递归
      9. 发言
         1. 发言标题
         2. 当前发言对象
         3. 下一名发言对象
      10. 上警退水（可被警长投票调用）
      11.
   6. 传输数据包：
      1. 操作数据（上传）
         1. 技能调用
         2. 投票数据
      2. 服务器信息（下行）
         1. 玩家状态更新
         2. 流程状态更新
      3. 同步数据
         1. 玩家状态

## 技术栈细节（边做边加！）

1. 页面预载
   1. 浏览器运行机制

## Coding!
